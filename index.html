<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
<title>Shift & Leave Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
}

*{box-sizing:border-box;-webkit-tap-highlight-color:transparent}
body{
  font-family:'Sarabun',sans-serif;
  background:var(--bg);
  margin:0;
  padding:20px;
  color:var(--text);
}

.header{text-align:center;margin-bottom:20px}
.header h1{margin:0;font-size:clamp(18px,4vw,26px);font-weight:700}
.header p{margin:5px 0 0;color:var(--muted);font-size:13px}

.container{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(260px,1fr));
  gap:15px;
  margin-bottom:20px;
}

.card{
  background:var(--card);
  padding:16px;
  border-radius:16px;
  box-shadow:0 6px 18px rgba(0,0,0,0.08);
}

.card h3{margin:0 0 10px 0;font-size:16px}

button{
  padding:10px 14px;
  border:none;
  border-radius:10px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  width:100%;
  margin-top:6px;
}
button:disabled{opacity:.6}

.select-btn{background:var(--primary);color:#fff}
.leave-btn{background:var(--warning);color:#fff}
.approve-btn{background:var(--success);color:#fff}

.status{margin-top:8px;font-weight:600;font-size:13px}
.approved{color:var(--success)}
.pending{color:var(--warning)}

.history-box{
  margin-top:12px;
  background:#f8fafc;
  padding:8px;
  border-radius:10px;
  font-size:12px;
  max-height:120px;
  overflow:auto;
}
.history-title{font-weight:700;margin-bottom:5px}

.calendar-card{
  background:var(--card);
  padding:15px;
  border-radius:18px;
  box-shadow:0 8px 20px rgba(0,0,0,0.08);
}

.calendar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:15px;
}

.calendar-header button{
  width:auto;
  padding:6px 10px;
  font-size:12px;
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:5px;
}

.day-name{text-align:center;font-weight:700;font-size:11px}

.day{
  background:#f9fafb;
  border-radius:10px;
  padding:5px;
  min-height:80px;
  font-size:10px;
  border:1px solid #e2e8f0;
}

.day-number{font-weight:700;margin-bottom:3px;font-size:11px}

.shift-label{
  background:#dbeafe;
  border-radius:6px;
  padding:2px 4px;
  font-size:9px;
  margin-bottom:2px;
}

.leave-item{
  background:#fee2e2;
  color:#991b1b;
  border-radius:6px;
  padding:2px 4px;
  font-size:9px;
  margin-bottom:2px;
}

.selected-day{outline:2px solid var(--warning)}

.footer-note{text-align:center;margin-top:20px;font-size:11px;color:var(--muted)}

/* Tablet */
@media(min-width:600px){
  .day{min-height:100px;font-size:11px}
  .shift-label,.leave-item{font-size:10px}
}

/* Desktop */
@media(min-width:1024px){
  body{padding:30px}
  .calendar-grid{gap:8px}
  .day{min-height:120px;font-size:12px}
  .shift-label,.leave-item{font-size:11px}
}
</style>
</head>
<body>

<div class="header">
  <h1>Shift & Leave Management System</h1>
  <p>Responsive • Mobile Ready • Cross-Device Compatible</p>
</div>

<div class="container" id="employeeContainer"></div>

<div class="calendar-card">
  <div class="calendar-header">
    <button onclick="changeMonth(-1)">◀</button>
    <h3 id="monthYear"></h3>
    <button onclick="changeMonth(1)">▶</button>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<div class="footer-note">Optimized for iOS • Android • Tablet • Desktop</div>

<script>
const sb = window.supabase.createClient(
  "https://apsycvcphtsylpwnnobz.supabase.co",
  "sb_publishable_zwvhZYtywa_EYmAzG6zaww_ACIWf5vO"
);

const employees=["เจ็ด","โอ้ต","เจน"];
let approvedLeaves=[];
let leaveHistory={};
let currentDate=new Date();
let activeLeaveEmployee=null;
let tempSelectedDates=[];

async function loadLeaves(){
  const {data}=await sb.from('leaves').select('*');
  if(!data)return;
  approvedLeaves=data.map(r=>({name:r.name,date:r.date}));
  leaveHistory={};
  employees.forEach(e=>leaveHistory[e]=[]);
  data.forEach(row=>{
    const approveTime=new Date(row.approved_at||new Date()).toLocaleString('th-TH');
    let record=leaveHistory[row.name].find(h=>h.approvedAt===approveTime);
    if(!record){record={dates:[],approvedAt:approveTime};leaveHistory[row.name].push(record);} 
    record.dates.push(row.date);
  });
  renderCalendar();
  employees.forEach(renderHistory);
}

function renderEmployees(){
  const container=document.getElementById("employeeContainer");
  container.innerHTML="";
  employees.forEach(emp=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3>${emp}</h3>
      <button class='select-btn' onclick="startSelecting('${emp}')">เลือกวันลา</button>
      <button class='leave-btn' onclick="requestLeave('${emp}')">ยืนยัน</button>
      <div id="selected-${emp}" style="margin-top:6px;font-size:12px"></div>
      <div class='status' id="status-${emp}"></div>
      <div id="approve-area-${emp}"></div>
      <div class='history-box'>
        <div class='history-title'>ประวัติเดือนนี้</div>
        <div id="history-${emp}">ยังไม่มี</div>
      </div>`;
    container.appendChild(card);
  });
}

function startSelecting(emp){
  activeLeaveEmployee=emp;
  tempSelectedDates=[];
  document.querySelectorAll('.day').forEach(d=>d.classList.remove('selected-day'));
  document.getElementById("selected-"+emp).innerText="";
}

function toggleSelectDate(date,el){
  if(!activeLeaveEmployee)return;
  if(tempSelectedDates.includes(date)){
    tempSelectedDates=tempSelectedDates.filter(d=>d!==date);
    el.classList.remove('selected-day');
  }else{
    if(tempSelectedDates.length>=4){alert("เลือกได้สูงสุด 4 วัน");return;}
    tempSelectedDates.push(date);
    el.classList.add('selected-day');
  }
  document.getElementById("selected-"+activeLeaveEmployee).innerText=
    tempSelectedDates.length?"เลือกแล้ว: "+tempSelectedDates.join(', '):"";
}

function requestLeave(emp){
  if(tempSelectedDates.length===0){alert("กรุณาเลือกวันลา");return;}
  const area=document.getElementById("approve-area-"+emp);
  area.innerHTML="";
  employees.filter(e=>e!==emp).forEach(other=>{
    const btn=document.createElement("button");
    btn.className="approve-btn";
    btn.innerText="อนุมัติจาก "+other;
    btn.onclick=()=>approveLeave(emp,btn);
    area.appendChild(btn);
  });
  document.getElementById("status-"+emp).innerHTML="<span class='pending'>รออนุมัติ</span>";
}

async function approveLeave(emp,btn){
  btn.disabled=true;
  const buttons=btn.parentElement.querySelectorAll('button');
  const approvedCount=[...buttons].filter(b=>b.disabled).length;
  if(approvedCount>=2){
    for(const date of tempSelectedDates){
      await sb.from('leaves').insert([{name:emp,date:date}]);
      approvedLeaves.push({name:emp,date:date});
    }
    leaveHistory[emp].push({dates:[...tempSelectedDates],approvedAt:new Date().toLocaleString('th-TH')});
    document.getElementById("status-"+emp).innerHTML="<span class='approved'>อนุมัติแล้ว</span>";
    document.getElementById("selected-"+emp).innerText="";
    btn.parentElement.innerHTML="";
    tempSelectedDates=[];
    activeLeaveEmployee=null;
    renderCalendar();
    renderHistory(emp);
  }
}

function renderCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const y=currentDate.getFullYear();
  const m=currentDate.getMonth();
  document.getElementById("monthYear").innerText=
    currentDate.toLocaleDateString('th-TH',{month:'long',year:'numeric'});
  const first=new Date(y,m,1).getDay();
  const total=new Date(y,m+1,0).getDate();

  ["อา","จ","อ","พ","พฤ","ศ","ส"].forEach(d=>{
    const div=document.createElement("div");
    div.className="day-name";
    div.innerText=d;
    cal.appendChild(div);
  });

  for(let i=0;i<first;i++)cal.appendChild(document.createElement("div"));

  for(let d=1;d<=total;d++){
    const div=document.createElement("div");
    div.className="day";
    div.innerHTML=`<div class='day-number'>${d}</div>`;
    const full=new Date(y,m,d).toISOString().split('T')[0];
    div.onclick=()=>toggleSelectDate(full,div);

    employees.forEach((emp,i)=>{
      const leave=approvedLeaves.find(l=>l.date===full&&l.name===emp);
      if(leave){
        div.innerHTML+=`<div class='leave-item'>${emp} ลา</div>`;
      }else{
        const shiftIndex=(i+m)%2;
        const shift=shiftIndex===0?"8:30-17:30":"11:00-20:00";
        div.innerHTML+=`<div class='shift-label'>${emp} ${shift}</div>`;
      }
    });
    cal.appendChild(div);
  }
}

function renderHistory(emp){
  const div=document.getElementById("history-"+emp);
  const history=leaveHistory[emp];
  if(!history||history.length===0){div.innerHTML="ยังไม่มี";return;}
  const m=currentDate.getMonth();
  const y=currentDate.getFullYear();
  const filtered=history.map(h=>{
    const dates=h.dates.filter(d=>{
      const dt=new Date(d);
      return dt.getMonth()===m&&dt.getFullYear()===y;
    });
    return {...h,dates};
  }).filter(h=>h.dates.length>0);
  if(filtered.length===0){div.innerHTML="ไม่มีในเดือนนี้";return;}
  div.innerHTML=filtered.map((h,i)=>
    `<div><strong>${i+1}</strong> ${h.dates.join(', ')}<br><small>${h.approvedAt}</small></div><hr>`
  ).join('');
}

function changeMonth(o){
  currentDate.setMonth(currentDate.getMonth()+o);
  renderCalendar();
  employees.forEach(renderHistory);
}

renderEmployees();
renderCalendar();
loadLeaves();
</script>

</body>
</html>
