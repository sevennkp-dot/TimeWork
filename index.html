<!DOCTYPE html>
<html lang="th">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Shift & Leave Management</title>
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<link href="https://fonts.googleapis.com/css2?family=Sarabun:wght@300;400;600;700&display=swap" rel="stylesheet">
<style>
:root{
  --primary:#2563eb;
  --success:#16a34a;
  --warning:#f59e0b;
  --danger:#dc2626;
  --bg:#f1f5f9;
  --card:#ffffff;
  --text:#0f172a;
  --muted:#64748b;
}

*{box-sizing:border-box}
body{
  font-family:'Sarabun',sans-serif;
  background:var(--bg);
  margin:0;
  padding:30px;
  color:var(--text);
}

.header{
  text-align:center;
  margin-bottom:30px;
}
.header h1{
  margin:0;
  font-size:26px;
  font-weight:700;
}
.header p{
  margin:5px 0 0;
  color:var(--muted);
  font-size:14px;
}

.container{
  display:grid;
  grid-template-columns:repeat(auto-fit,minmax(280px,1fr));
  gap:20px;
  margin-bottom:30px;
}

.card{
  background:var(--card);
  padding:20px;
  border-radius:16px;
  box-shadow:0 8px 25px rgba(0,0,0,0.08);
  transition:.2s ease;
}
.card:hover{
  transform:translateY(-3px);
}

.card h3{
  margin-top:0;
  margin-bottom:10px;
}

button{
  padding:8px 14px;
  border:none;
  border-radius:8px;
  cursor:pointer;
  font-weight:600;
  font-size:13px;
  transition:.2s;
}
button:disabled{
  opacity:.6;
  cursor:not-allowed;
}

.select-btn{background:var(--primary);color:#fff;}
.leave-btn{background:var(--warning);color:#fff;margin-left:5px;}
.approve-btn{background:var(--success);color:#fff;margin-top:5px;width:100%;}

.status{
  margin-top:10px;
  font-weight:600;
}
.approved{color:var(--success)}
.pending{color:var(--warning)}

.history-box{
  margin-top:15px;
  background:#f8fafc;
  padding:10px;
  border-radius:10px;
  font-size:12px;
  max-height:150px;
  overflow:auto;
}
.history-title{
  font-weight:700;
  margin-bottom:6px;
}

.calendar-card{
  background:var(--card);
  padding:25px;
  border-radius:20px;
  box-shadow:0 10px 30px rgba(0,0,0,0.1);
  max-width:1200px;
  margin:auto;
}

.calendar-header{
  display:flex;
  justify-content:space-between;
  align-items:center;
  margin-bottom:20px;
}

.calendar-header h3{
  margin:0;
  font-size:18px;
}

.calendar-grid{
  display:grid;
  grid-template-columns:repeat(7,1fr);
  gap:8px;
}

.day-name{
  text-align:center;
  font-weight:700;
  font-size:13px;
}

.day{
  background:#f9fafb;
  border-radius:12px;
  padding:8px;
  min-height:120px;
  font-size:12px;
  cursor:pointer;
  transition:.2s;
  border:1px solid #e2e8f0;
}
.day:hover{
  background:#eef2ff;
}

.day-number{
  font-weight:700;
  margin-bottom:5px;
}

.shift-label{
  background:#dbeafe;
  border-radius:6px;
  padding:3px 6px;
  font-size:11px;
  margin-bottom:3px;
}

.leave-item{
  background:#fee2e2;
  color:#991b1b;
  border-radius:6px;
  padding:3px 6px;
  font-size:11px;
  margin-bottom:3px;
}

.selected-day{
  outline:3px solid var(--warning);
}

.badge{
  display:inline-block;
  padding:3px 8px;
  border-radius:20px;
  font-size:11px;
  font-weight:600;
  background:#e0f2fe;
  color:#0369a1;
  margin-left:6px;
}

.footer-note{
  text-align:center;
  margin-top:25px;
  font-size:12px;
  color:var(--muted);
}
</style>
</head>
<body>

<div class="header">
  <h1>Shift & Leave Management System</h1>
  <p>ระบบจัดตารางกะและการลาพนักงาน (Connected to Supabase)</p>
</div>

<div class="container" id="employeeContainer"></div>

<div class="calendar-card">
  <div class="calendar-header">
    <button onclick="changeMonth(-1)">◀ เดือนก่อน</button>
    <h3 id="monthYear"></h3>
    <button onclick="changeMonth(1)">เดือนถัดไป ▶</button>
  </div>
  <div class="calendar-grid" id="calendar"></div>
</div>

<div class="footer-note">
  ระบบพร้อมใช้งานระดับองค์กร • Auto Rotation • Multi-day Leave • Approval Workflow
</div>

<script>
const sb = window.supabase.createClient(
  "https://apsycvcphtsylpwnnobz.supabase.co",
  "sb_publishable_zwvhZYtywa_EYmAzG6zaww_ACIWf5vO"
);

const employees=["เจ็ด","โอ้ต","เจน"];
let approvedLeaves=[];
let leaveHistory={};
let currentDate=new Date();
let activeLeaveEmployee=null;
let tempSelectedDates=[];

async function loadLeaves(){
  const {data,error}=await sb.from('leaves').select('*').order('approved_at',{ascending:true});
  if(error){console.error(error);return;}

  approvedLeaves=data.map(r=>({name:r.name,date:r.date}));
  leaveHistory={};
  employees.forEach(e=>leaveHistory[e]=[]);

  data.forEach(row=>{
    const approveTime=new Date(row.approved_at||new Date()).toLocaleString('th-TH');
    let record=leaveHistory[row.name].find(h=>h.approvedAt===approveTime);
    if(!record){
      record={dates:[],approvedAt:approveTime};
      leaveHistory[row.name].push(record);
    }
    record.dates.push(row.date);
  });

  renderCalendar();
  employees.forEach(renderHistory);
}

function renderEmployees(){
  const container=document.getElementById("employeeContainer");
  container.innerHTML="";

  employees.forEach(emp=>{
    const card=document.createElement("div");
    card.className="card";
    card.innerHTML=`
      <h3>${emp}<span class='badge'>Active</span></h3>
      <button class='select-btn' onclick="startSelecting('${emp}')">เลือกวันลา</button>
      <button class='leave-btn' onclick="requestLeave('${emp}')">ยืนยัน</button>
      <div id="selected-${emp}" style="margin-top:8px;font-size:12px;color:#334155"></div>
      <div class='status' id="status-${emp}"></div>
      <div id="approve-area-${emp}"></div>
      <div class='history-box'>
        <div class='history-title'>ประวัติการลา</div>
        <div id="history-${emp}">ยังไม่มีประวัติ</div>
      </div>`;
    container.appendChild(card);
  });
}

function startSelecting(emp){
  activeLeaveEmployee=emp;
  tempSelectedDates=[];
  document.querySelectorAll('.day').forEach(d=>d.classList.remove('selected-day'));
  document.getElementById("selected-"+emp).innerText="";
}

function toggleSelectDate(date,el){
  if(!activeLeaveEmployee)return;
  if(tempSelectedDates.includes(date)){
    tempSelectedDates=tempSelectedDates.filter(d=>d!==date);
    el.classList.remove('selected-day');
  }else{
    if(tempSelectedDates.length>=4){alert("เลือกได้สูงสุด 4 วัน");return;}
    tempSelectedDates.push(date);
    el.classList.add('selected-day');
  }
  document.getElementById("selected-"+activeLeaveEmployee).innerText=
    tempSelectedDates.length?"เลือกแล้ว: "+tempSelectedDates.join(', '):"";
}

function requestLeave(emp){
  if(tempSelectedDates.length===0){alert("กรุณาเลือกวันลา");return;}
  const area=document.getElementById("approve-area-"+emp);
  area.innerHTML="";
  employees.filter(e=>e!==emp).forEach(other=>{
    const btn=document.createElement("button");
    btn.className="approve-btn";
    btn.innerText="อนุมัติจาก "+other;
    btn.onclick=()=>approveLeave(emp,btn);
    area.appendChild(btn);
  });
  document.getElementById("status-"+emp).innerHTML="<span class='pending'>รอการอนุมัติ</span>";
}

async function approveLeave(emp,btn){
  btn.disabled=true;
  const buttons=btn.parentElement.querySelectorAll('button');
  const approvedCount=[...buttons].filter(b=>b.disabled).length;
  if(approvedCount>=2){
    for(const date of tempSelectedDates){
      await sb.from('leaves').insert([{name:emp,date:date}]);
      approvedLeaves.push({name:emp,date:date});
    }
    leaveHistory[emp].push({dates:[...tempSelectedDates],approvedAt:new Date().toLocaleString('th-TH')});
    document.getElementById("status-"+emp).innerHTML="<span class='approved'>อนุมัติแล้ว</span>";
    document.getElementById("selected-"+emp).innerText="";
    btn.parentElement.innerHTML="";
    tempSelectedDates=[];
    activeLeaveEmployee=null;
    renderCalendar();
    renderHistory(emp);
  }
}

function renderCalendar(){
  const cal=document.getElementById("calendar");
  cal.innerHTML="";
  const y=currentDate.getFullYear();
  const m=currentDate.getMonth();
  document.getElementById("monthYear").innerText=
    currentDate.toLocaleDateString('th-TH',{month:'long',year:'numeric'});
  const first=new Date(y,m,1).getDay();
  const total=new Date(y,m+1,0).getDate();

  ["อา","จ","อ","พ","พฤ","ศ","ส"].forEach(d=>{
    const div=document.createElement("div");
    div.className="day-name";
    div.innerText=d;
    cal.appendChild(div);
  });

  for(let i=0;i<first;i++)cal.appendChild(document.createElement("div"));

  for(let d=1;d<=total;d++){
    const div=document.createElement("div");
    div.className="day";
    div.innerHTML=`<div class='day-number'>${d}</div>`;
    const full=new Date(y,m,d).toISOString().split('T')[0];
    div.onclick=()=>toggleSelectDate(full,div);

    employees.forEach((emp,i)=>{
      const leave=approvedLeaves.find(l=>l.date===full&&l.name===emp);
      if(leave){
        div.innerHTML+=`<div class='leave-item'>${emp} ลา</div>`;
      }else{
        const shiftIndex=(i+m)%2;
        const shift=shiftIndex===0?"8:30-17:30":"11:00-20:00";
        div.innerHTML+=`<div class='shift-label'>${emp} : ${shift}</div>`;
      }
    });
    cal.appendChild(div);
  }
}

function renderHistory(emp){
  const div=document.getElementById("history-"+emp);
  const history=leaveHistory[emp];
  if(!history||history.length===0){div.innerHTML="ยังไม่มีประวัติ";return;}
  div.innerHTML=history.map((h,i)=>
    `<div><strong>ครั้งที่ ${i+1}</strong><br>${h.dates.join(', ')}<br><small>${h.approvedAt}</small></div><hr>`
  ).join('');
}

function changeMonth(o){
  currentDate.setMonth(currentDate.getMonth()+o);
  renderCalendar();
}

renderEmployees();
renderCalendar();
loadLeaves();
</script>

</body>
</html>
